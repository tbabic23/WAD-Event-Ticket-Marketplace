<main class="profile-container">
    <div class="profile-box">
        <div class="tabs">
            <button class="tab-btn" [class.active]="activeTab === 'profile'" (click)="switchTab('profile')">
                Profile
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'tickets'" (click)="switchTab('tickets')">
                My Tickets
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'orders'" (click)="switchTab('orders')">
                My Orders
            </button>
            <button *ngIf="isCreatorOrAdmin()" class="tab-btn" [class.active]="activeTab === 'events'" (click)="switchTab('events')">
                My Events
            </button>
        </div>

        <!-- Profile Tab -->
        <div *ngIf="activeTab === 'profile'" class="tab-content">
            <h1>Profile</h1>
            <p>Manage your account</p>

            <div *ngIf="user" class="profile-info">
                <div class="info-row">
                    <label>Username</label>
                    <div class="info-value">{{ user.username }}</div>
                </div>

                <div class="info-row">
                    <label>Email</label>
                    <div class="info-value">{{ user.email }}</div>
                </div>

                <div class="info-row">
                    <label>Name</label>
                    <div class="info-value">{{ user.first_name }} {{ user.last_name }}</div>
                </div>

                <div class="info-row">
                    <label>Role</label>
                    <div class="info-value role-badge">{{ user.role }}</div>
                </div>

                <button (click)="logout()" class="logout-btn">Logout</button>
            </div>
        </div>

        <!-- My Tickets Tab -->
        <div *ngIf="activeTab === 'tickets'" class="tab-content">
            <h1>My Tickets</h1>
            <p>View and manage your event tickets</p>

            <div *ngIf="isLoading" class="loading">Loading tickets...</div>

            <div *ngIf="!isLoading && tickets.length === 0" class="empty-state">
                <p>You don't have any tickets yet.</p>
            </div>

            <div *ngIf="!isLoading && tickets.length > 0" class="tickets-grid">
                <div *ngFor="let ticket of tickets" class="ticket-card">
                    <div class="ticket-header">
                        <h3>{{ ticket.event_title }}</h3>
                        <span class="status-badge" [ngClass]="getStatusClass(ticket.status)">
                            {{ ticket.status }}
                        </span>
                    </div>
                    <div class="ticket-details">
                        <p><strong>Ticket Type:</strong> {{ ticket.ticket_type_name }}</p>
                        <p><strong>Price:</strong> ${{ ticket.price }}</p>
                        <p><strong>Venue:</strong> {{ ticket.venue }}</p>
                        <p><strong>Date:</strong> {{ formatDate(ticket.event_date) }}</p>
                        <p><strong>Ticket Code:</strong> {{ ticket.ticket_code }}</p>
                    </div>
                    <button class="qr-btn" (click)="generateQR(ticket)" [disabled]="ticket.status !== 'valid'">
                        Generate QR Code
                    </button>
                </div>
            </div>
        </div>

        <!-- My Orders Tab -->
        <div *ngIf="activeTab === 'orders'" class="tab-content">
            <h1>My Orders</h1>
            <p>View your order history</p>

            <div *ngIf="isLoading" class="loading">Loading orders...</div>

            <div *ngIf="!isLoading && orders.length === 0" class="empty-state">
                <p>You don't have any orders yet.</p>
            </div>

            <div *ngIf="!isLoading && orders.length > 0" class="orders-list">
                <div *ngFor="let order of orders" class="order-card">
                    <div class="order-header">
                        <h3>{{ order.event_title }}</h3>
                        <span class="status-badge" [ngClass]="getStatusClass(order.status)">
                            {{ order.status }}
                        </span>
                    </div>
                    <div class="order-details">
                        <p><strong>Order #:</strong> {{ order.order_number }}</p>
                        <p><strong>Total:</strong> ${{ order.total_amount }}</p>
                        <p><strong>Venue:</strong> {{ order.venue }}</p>
                        <p><strong>Event Date:</strong> {{ formatDate(order.event_date) }}</p>
                        <p><strong>Order Date:</strong> {{ formatDate(order.created_at) }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- My Events Tab -->
        <div *ngIf="activeTab === 'events'" class="tab-content">
            <h1>My Events</h1>
            <p>Manage your events and scan tickets</p>

            <div *ngIf="isLoading" class="loading">Loading events...</div>

            <div *ngIf="!isLoading && myEvents.length === 0" class="empty-state">
                <p>You haven't created any events yet</p>
            </div>

            <div *ngIf="!isLoading && myEvents.length > 0" class="events-list">
                <div *ngFor="let event of myEvents" class="event-card-profile">
                    <div class="event-card-header">
                        <h3>{{ event.title }}</h3>
                        <span class="event-status" [ngClass]="event.confirmed ? 'confirmed' : 'pending'">
                            {{ event.confirmed ? 'Confirmed' : 'Pending' }}
                        </span>
                    </div>
                    <div class="event-card-details">
                        <p><strong>Venue:</strong> {{ event.venue }}</p>
                        <p><strong>Date:</strong> {{ formatDate(event.event_date) }}</p>
                        <p *ngIf="event.city"><strong>Location:</strong> {{ event.city }}</p>
                    </div>
                    <button class="scan-btn-profile" (click)="openScanModal(event)">
                        Scan Tickets
                    </button>
                </div>
            </div>
        </div>

    <!-- QR Code Modal -->
    <div *ngIf="selectedTicketQR" class="qr-modal-overlay" (click)="closeQR()">
        <div class="qr-modal-content" (click)="$event.stopPropagation()">
            <div class="qr-modal-header">
                <h2>Your Ticket QR Code</h2>
                <button class="close-btn" (click)="closeQR()">&times;</button>
            </div>
            <div class="qr-code-display">
                <img [src]="selectedTicketQR" alt="QR Code">
                <p class="ticket-code">Code: {{ selectedTicketCode }}</p>
            </div>
        </div>
    </div>

    <!-- Scan Modal -->
    <div *ngIf="showScanModal" class="qr-modal-overlay" (click)="closeScanModal()">
        <div class="scan-modal-content" (click)="$event.stopPropagation()">
            <div class="qr-modal-header">
                <h2>Scan Ticket - {{ selectedEventForScan?.title }}</h2>
                <button class="close-btn" (click)="closeScanModal()">&times;</button>
            </div>

            <div class="scan-modal-body">
                <p class="scan-instruction">Enter the ticket code to verify entry</p>

                <div class="scan-input-group-simple">
                    <input
                        type="text"
                        [(ngModel)]="scanTicketCode"
                        placeholder="Enter ticket code (e.g. TKT-xxxxx)"
                        class="scan-input-simple"
                        (keyup.enter)="scanTicket()"
                        autofocus>
                    <button class="scan-btn-simple" (click)="scanTicket()" [disabled]="!scanTicketCode">
                        Verify
                    </button>
                </div>

                <div *ngIf="showScanResult" class="scan-result-simple" [ngClass]="scanResult.success ? 'result-success' : 'result-error'">
                    <div class="result-icon-simple">{{ scanResult.success ? '✓' : '✗' }}</div>
                    <h3>{{ scanResult.success ? 'Entry Granted' : 'Entry Denied' }}</h3>
                    <p>{{ scanResult.message }}</p>
                </div>
            </div>
        </div>
    </div>
</main>
